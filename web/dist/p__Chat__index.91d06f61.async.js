"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{30778:function(ft,ee,i){i.r(ee),i.d(ee,{default:function(){return Ge}});var ye=i(19632),te=i.n(ye),Se=i(15009),A=i.n(Se),je=i(99289),I=i.n(je),Ce=i(5574),x=i.n(Ce),c=i(67294),Z=i(2453),Y=i(74330),Fe=i(4393),K=i(86250),Me=i(78367),ne=i(83622),Re=i(17788),we=i(72269),Ae=i(16596),be=i(82061),re=i(76654),Ze=i(99097),Be=i(86762),k=i(42075),ae=i(95715),L=i(2618),Ee=i(24495),pt=i(63334),se=i(96486),n=i(85893),Le=i(95150),De=Le({html:!0,breaks:!0}),ie="",We=function(s,u,h,g,m){var C=(0,c.useState)(null),S=x()(C,2),f=S[0],y=S[1],R=(0,c.useState)(!0),j=x()(R,2),b=j[0],z=j[1],X=(0,c.useState)(null),D=x()(X,2),U=D[0],W=D[1];return(0,c.useEffect)(function(){var H=function(){var P=I()(A()().mark(function B(){var w;return A()().wrap(function(p){for(;;)switch(p.prev=p.next){case 0:if(p.prev=0,s!="custom"){p.next=6;break}y({desc:"",musicUrl:h,title:m,preview:g}),window.dispatchEvent(new CustomEvent("add-to-playlist",{detail:{name:m||"\u672A\u77E5\u6807\u9898",artist:"",url:h||"",cover:g||"https://picsum.photos/128/128"}})),p.next=13;break;case 6:return p.next=8,(0,L.Hv)({type:s,id:u});case 8:if(w=p.sent,!w.error){p.next=11;break}throw new Error(w.error);case 11:y(w),window.dispatchEvent(new CustomEvent("add-to-playlist",{detail:{name:w.title||"\u672A\u77E5\u6807\u9898",artist:w.desc||"\u65E0\u63CF\u8FF0",url:w.musicUrl||"",cover:w.preview||"https://picsum.photos/128/128"}}));case 13:p.next=18;break;case 15:p.prev=15,p.t0=p.catch(0),W(p.t0||"\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25");case 18:return p.prev=18,z(!1),p.finish(18);case 21:case"end":return p.stop()}},B,null,[[0,15,18,21]])}));return function(){return P.apply(this,arguments)}}();H()},[s,u]),b?(0,n.jsx)(Y.Z,{style:{width:100,height:150,maxWidth:"100%",display:"flex",justifyContent:"center",alignItems:"center"}}):U?(0,n.jsx)("div",{children:U}):(0,n.jsxs)(k.Z,{direction:"vertical",style:{alignItems:"center",rowGap:0,width:100},children:[(0,n.jsx)(k.Z,{children:(0,n.jsx)(ae.Z,{src:(f==null?void 0:f.preview)||"https://picsum.photos/128/128",width:100,style:{borderRadius:"5px"}})}),(0,n.jsx)(k.Z,{style:{fontSize:"16px",fontWeight:"bold"},children:(f==null?void 0:f.title)||"\u672A\u77E5\u6807\u9898"}),(0,n.jsx)(k.Z,{style:{fontSize:"12px"},children:(f==null?void 0:f.desc)||"\u65E0\u63CF\u8FF0"})]})},Te=function(s){return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"16px"},children:(0,n.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:"\u8F6C\u53D1\u6D88\u606F"})}),(0,n.jsx)(re.Z.List,{items:s.map(function(u,h){return{key:h,placement:"start",shape:"corner",content:Q(u.data.content,"start",null)}})})]})},Ie=function(s){var u=c.useRef(null);return(0,c.useEffect)(function(){u.current&&window.DPlayer&&(u.current.innerHTML="",new window.DPlayer({container:u.current,video:{url:s},screenshot:!0}))},[s]),(0,n.jsx)("div",{ref:u,style:{maxWidth:"350px"}})},ke=function(s){var u=(0,c.useState)(!0),h=x()(u,2),g=h[0],m=h[1];return s.startsWith("http")||s.startsWith("base64")?(s.startsWith("base64")&&(s="data:image/png;base64,"+s.split(",")[1]),(0,n.jsx)("div",{style:{width:"200px",maxWidth:"200px",cursor:"pointer",marginTop:"5px"},children:(0,n.jsx)(Y.Z,{spinning:g,children:(0,n.jsx)(ae.Z,{src:s,onLoad:function(){return m(!1)}})})})):null},ze=function(s){return(0,n.jsx)("audio",{src:s,controls:!0,style:{width:"300px"}})},Ue=function(s){return s?(0,n.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"12px"},children:(0,n.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"4px"},children:s.length>50?"".concat(s.substring(0,50),"..."):s})}):null},He=function(s,u){var h={uid:"1",name:u,url:s};return(0,n.jsx)("a",{style:{color:"inherit"},href:s,target:"_blank",download:u,children:(0,n.jsx)(Ee.Z.FileCard,{item:h})})},Pe=function(s,u){return(0,n.jsx)("div",{children:u=="start"?(0,n.jsx)("div",{dangerouslySetInnerHTML:{__html:De.render(s)}}):(0,n.jsx)("div",{children:s})})},Q=function(s,u,h){return s.map(function(g,m){var C,S,f,y,R;if(g.type=="text")return Pe(g.data.text,u);var j=(C=g.data)===null||C===void 0?void 0:C.file,b=j!=null&&j.startsWith("file")?"".concat(ie,"/api/chat/file?path=").concat(j):j;switch(g.type){case"music":return We(g.data.type,(S=g.data)===null||S===void 0?void 0:S.id,(f=g.data)===null||f===void 0?void 0:f.audio,(y=g.data)===null||y===void 0?void 0:y.image,(R=g.data)===null||R===void 0?void 0:R.title);case"image":return ke(b);case"video":return Ie(b);case"record":return ze(b);case"reply":return Ue(h);case"at":return(0,n.jsx)("i",{style:{fontSize:12},children:u=="start"?"@\u4F60":"@\u673A\u5668\u4EBA"});default:return null}})},Oe=function(s){var u=s.role,h=s.replyContent,g=s.message_id,m=s.message;if((0,se.isArray)(m))return Q(m,u,h||null);var C,S,f=m.action,y=(C=m.params)===null||C===void 0?void 0:C.messages,R=(S=m.params)===null||S===void 0?void 0:S.message;switch(f){case"send_group_forward_msg":if(y)return Te(y);case"send_group_msg":if(R)return Q(R,u,h||null);case"upload_group_file":var j="".concat(ie,"/api/chat/file?path=").concat(m.params.file);return He(j,m.params.name);default:return(0,n.jsx)("i",{style:{fontSize:"12px"},children:"\u672A\u5904\u7406\u4E8B\u4EF6\uFF1A".concat(f)})}},Ne=Oe,Je="/api/ws",Ve=function(){var s,u=(0,c.useState)(!1),h=x()(u,2),g=h[0],m=h[1],C=(0,c.useState)(!1),S=x()(C,2),f=S[0],y=S[1],R=(0,c.useState)(!1),j=x()(R,2),b=j[0],z=j[1],X=(0,c.useState)(!1),D=x()(X,2),U=D[0],W=D[1],H=c.useRef(null),P=(0,Be.useModel)("@@initialState"),B=P.initialState,w=P.setInitialState,le=B==null||(s=B.settings)===null||s===void 0?void 0:s.isDark,p=(0,c.useState)([]),oe=x()(p,2),O=oe[0],N=oe[1],$=(0,c.useRef)([]),Ye=(0,c.useState)(null),ue=x()(Ye,2),T=ue[0],Ke=ue[1],Qe=c.useState(!0),de=x()(Qe,2),Xe=de[0],ce=de[1],$e=c.useState(!0),ve=x()($e,2),fe=ve[0],qe=ve[1],J=(0,c.useRef)(null),_e=c.useRef(null),et=(0,c.useState)(""),pe=x()(et,2),tt=pe[0],q=pe[1],ht={};(0,c.useEffect)(function(){return nt(),function(){T&&T.close()}},[]),(0,c.useEffect)(function(){ot(),$.current=O},[O]);var nt=function(){var d=I()(A()().mark(function a(){var e,t,r,l,o,F,E;return A()().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return v.prev=0,v.next=3,(0,L.$i)({start:0,end:999999});case 3:for(e=v.sent,t=[],r=e.data.length-1;r>=0;r--)l=e.data[r],Array.isArray(l)&&l.length===1&&(F=JSON.parse(l[0]),E=(o=F.message)!==null&&o!==void 0&&(o=o.params)!==null&&o!==void 0&&(o=o.message)!==null&&o!==void 0&&(o=o[0])!==null&&o!==void 0&&(o=o.data)!==null&&o!==void 0&&o.id?rt(t,F.message.params.message[0].data.id):null,F.replyContent=E,t.push(F));N(t),$.current=t,v.next=13;break;case 10:v.prev=10,v.t0=v.catch(0),Z.ZP.error("\u5386\u53F2\u6D88\u606F\u52A0\u8F7D\u5931\u8D25: ".concat(v.t0));case 13:return v.prev=13,at(),v.finish(13);case 16:case"end":return v.stop()}},a,null,[[0,10,13,16]])}));return function(){return d.apply(this,arguments)}}(),rt=function(a,e){var t=a.find(function(o){return o.message_id==e}),r=(t==null?void 0:t.role)=="start"?t==null?void 0:t.message.params.message.at(-1):t==null?void 0:t.message.at(-1);if((r==null?void 0:r.type)=="text")return r.data.text;if(r!=null&&r.type){var l={image:"\u56FE\u7247",node:"\u8F6C\u53D1\u6D88\u606F",music:"\u97F3\u4E50",audio:"\u8BED\u97F3",video:"\u89C6\u9891",file:"\u6587\u4EF6"};return"[".concat(l[r.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},at=function d(){var a=new WebSocket("".concat(L.H9).concat(Je,"?auth_token=").concat(localStorage.getItem("auth_token")));a.onopen=function(){ce(!1)},a.onmessage=function(e){st(e.data)},a.onclose=function(){window.location.pathname=="/chat"&&(ce(!0),setTimeout(d,5e3))},a.onerror=function(e){Z.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},Ke(a)},gt=function(){var d=I()(A()().mark(function a(e){return A()().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",null);case 1:case"end":return r.stop()}},a)}));return function(e){return d.apply(this,arguments)}}(),st=function(a){try{var e,t=JSON.parse(a);if(!t.message){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",t);return}var r=(e=t.message)!==null&&e!==void 0&&(e=e.params)!==null&&e!==void 0&&(e=e.message)!==null&&e!==void 0&&(e=e[0])!==null&&e!==void 0&&(e=e.data)!==null&&e!==void 0&&e.id?it(t.message.params.message[0].data.id):null,l={role:(0,se.isArray)(t==null?void 0:t.message)?"end":"start",replyContent:r,message_id:t.message_id,message:t.message};N(function(o){return o.some(function(F){return F.message_id===l.message_id})?o:[].concat(te()(o),[l])})}catch(o){console.warn(o)}},it=function(a){var e=$.current.find(function(l){return l.message_id==a}),t=(e==null?void 0:e.role)=="start"?e==null?void 0:e.message.params.message.at(-1):e==null?void 0:e.message.at(-1);if((t==null?void 0:t.type)=="text")return t.data.text;if(t!=null&&t.type){var r={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(r[t.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},lt=function(a,e){var t={role:"end",message_id:e,message:a};N(function(r){return r.some(function(l){return l.message_id===t.message_id})?r:[].concat(te()(r),[t])})},ot=function(){J.current&&(J.current.scrollTop=J.current.scrollHeight)},he=function(a,e){if(a.trim())if(T&&T.readyState===WebSocket.OPEN){var t;m(!0);var r=Date.now(),l=[{msg_id:r},{type:e,data:e=="text"?{text:a}:{file:a}}];fe&&l.splice(1,0,{type:"at",data:{qq:"1000000",name:"Eridanus"}}),lt(l,r),T.send(JSON.stringify(l)),(t=H.current)===null||t===void 0||t.scrollTo({key:O.length-1,block:"nearest"}),q(""),setTimeout(function(){m(!1)},500)}else Z.ZP.error("WebSocket \u672A\u8FDE\u63A5")},ut=function(){var d=I()(A()().mark(function a(){var e;return A()().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return z(!0),r.next=3,(0,L.qH)(null);case 3:e=r.sent,e!=null&&e.message?(N([]),Z.ZP.success(e.message)):Z.ZP.error(e==null?void 0:e.error),z(!1),W(!1);case 7:case"end":return r.stop()}},a)}));return function(){return d.apply(this,arguments)}}(),ge={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatCard:{width:"100%",height:"calc(100vh-100px)",display:"flex",flexDirection:"column"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",borderRadius:"12px",height:"auto",marginBottom:"115px",overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{position:"absolute",left:"0",bottom:"0px",backgroundColor:le?"#2e2e2e":"#fff",maxHeight:"50vh",overflowY:"auto"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}},dt=function(a){return a.replace(/[^a-zA-Z0-9._-]/g,"_")},ct=Z.ZP.useMessage(),me=x()(ct,2),xe=me[0],vt=me[1],V=function(a,e,t,r){var l=dt(r);a<100?xe.open({key:l,type:"loading",content:"\u6B63\u5728\u4E0A\u4F20: ".concat(a,"%"),duration:0}):e&&xe.open({key:l,type:t?"success":"error",content:t?"".concat(r," \u4E0A\u4F20\u6210\u529F"):"".concat(r," \u4E0A\u4F20\u5931\u8D25"),duration:2})};return(0,n.jsx)(Y.Z,{spinning:Xe,tip:"WebSocket\u8FDE\u63A5\u4E2D...",size:"large",children:(0,n.jsxs)(Fe.Z,{style:{height:"calc(100vh - 100px)"},children:[vt,(0,n.jsxs)("div",{ref:_e,style:{width:"100%",height:"calc(100vh - 100px)",display:"flex",flexDirection:"column"},children:[(0,n.jsx)("div",{style:ge.chatContainer,ref:J,children:(0,n.jsx)(re.Z.List,{ref:H,items:O.map(function(d,a){return{key:a,placement:d.role,shape:"corner",content:(0,n.jsx)(Ne,{role:d.role,replyContent:d.replyContent,message:d.message,message_id:d.message_id},a)}})})}),(0,n.jsx)(Ze.Z,{placeholder:"\u8BF7\u8F93\u5165...",style:ge.bottomTools,value:tt,autoSize:{maxRows:8},onChange:function(a){q(a)},onSubmit:function(a){q(""),he(a,"text")},actions:!1,footer:function(a){var e=a.components,t=e.SendButton;return(0,n.jsxs)(K.Z,{justify:"space-between",align:"center",children:[(0,n.jsxs)(K.Z,{gap:"small",align:"center",children:[(0,n.jsx)(Me.Z,{accept:"image/*",pastable:!0,name:"file",action:"".concat(L.H9,"/api/chat/uploadFile"),onChange:function(l){y(!0);var o=l.file.name;if(l.file.status=="uploading"){var F,E;V(Math.floor((F=(E=l.event)===null||E===void 0?void 0:E.percent)!==null&&F!==void 0?F:0),!1,!1,o)}if(l.file.status==="done"){var G;console.log(l.file.response);var v=l.file.response;if(v!=null&&(G=v.files[0])!==null&&G!==void 0&&G.error)V(100,!0,!1,o),y(!1);else{var _;he(v==null||(_=v.files[0])===null||_===void 0?void 0:_.path,"image"),V(100,!0,!0,o),y(!1)}}else l.file.status==="error"&&(V(100,!0,!1,o),y(!1))},maxCount:1,multiple:!1,showUploadList:!1,children:(0,n.jsx)(ne.ZP,{disabled:f,type:"text",icon:(0,n.jsx)(Ae.Z,{})})}),(0,n.jsx)(ne.ZP,{type:"text",onClick:function(){return W(!0)},icon:(0,n.jsx)(be.Z,{})}),(0,n.jsx)(Re.Z,{title:"\u63D0\u793A",open:U,onOk:function(){return ut()},confirmLoading:b,onCancel:function(){return W(!1)},children:(0,n.jsx)("p",{children:"\u786E\u8BA4\u6E05\u7A7A\u804A\u5929\u8BB0\u5F55\u5417\uFF1F\u804A\u5929\u6587\u4EF6\u4E0D\u4F1A\u88AB\u5220\u9664\u3002"})}),"@\u673A\u5668\u4EBA",(0,n.jsx)(we.Z,{size:"small",checked:fe,onChange:function(l){qe(l)}})]}),(0,n.jsx)(K.Z,{align:"center",children:(0,n.jsx)(t,{type:"primary",loading:g,disabled:!1})})]})}})]})]})})},Ge=Ve}}]);
