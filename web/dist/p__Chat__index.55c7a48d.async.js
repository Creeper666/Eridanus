"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{30778:function(ut,q,i){i.r(q),i.d(q,{default:function(){return Je}});var me=i(19632),_=i.n(me),xe=i(15009),Z=i.n(xe),ye=i(99289),k=i.n(ye),Se=i(5574),x=i.n(Se),c=i(67294),B=i(2453),Y=i(74330),je=i(45416),K=i(86250),Ce=i(99842),ee=i(71577),Re=i(88556),Fe=i(57478),Me=i(16596),we=i(82061),te=i(63254),Ae=i(2987),Ze=i(84226),I=i(34586),re=i(68627),L=i(2618),be=i(52077),dt=i(63334),ne=i(96486),r=i(85893),Be=i(95150),Ee=Be({html:!0,breaks:!0}),ae="",Le=function(s,o,p,h,g){var C=(0,c.useState)(null),y=x()(C,2),v=y[0],m=y[1],M=(0,c.useState)(!0),S=x()(M,2),b=S[0],z=S[1],X=(0,c.useState)(null),D=x()(X,2),U=D[0],T=D[1];return(0,c.useEffect)(function(){var H=function(){var P=k()(Z()().mark(function E(){var w;return Z()().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(f.prev=0,s!="custom"){f.next=6;break}m({desc:"",musicUrl:p,title:g,preview:h}),window.dispatchEvent(new CustomEvent("add-to-playlist",{detail:{name:g||"\u672A\u77E5\u6807\u9898",artist:"",url:p||"",cover:h||"https://picsum.photos/128/128"}})),f.next=13;break;case 6:return f.next=8,(0,L.Hv)({type:s,id:o});case 8:if(w=f.sent,!w.error){f.next=11;break}throw new Error(w.error);case 11:m(w),window.dispatchEvent(new CustomEvent("add-to-playlist",{detail:{name:w.title||"\u672A\u77E5\u6807\u9898",artist:w.desc||"\u65E0\u63CF\u8FF0",url:w.musicUrl||"",cover:w.preview||"https://picsum.photos/128/128"}}));case 13:f.next=18;break;case 15:f.prev=15,f.t0=f.catch(0),T(f.t0||"\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25");case 18:return f.prev=18,z(!1),f.finish(18);case 21:case"end":return f.stop()}},E,null,[[0,15,18,21]])}));return function(){return P.apply(this,arguments)}}();H()},[s,o]),b?(0,r.jsx)(Y.Z,{style:{width:100,height:150,maxWidth:"100%",display:"flex",justifyContent:"center",alignItems:"center"}}):U?(0,r.jsx)("div",{children:U}):(0,r.jsxs)(I.Z,{direction:"vertical",style:{alignItems:"center",rowGap:0,width:100},children:[(0,r.jsx)(I.Z,{children:(0,r.jsx)(re.Z,{src:(v==null?void 0:v.preview)||"https://picsum.photos/128/128",width:100,style:{borderRadius:"5px"}})}),(0,r.jsx)(I.Z,{style:{fontSize:"16px",fontWeight:"bold"},children:(v==null?void 0:v.title)||"\u672A\u77E5\u6807\u9898"}),(0,r.jsx)(I.Z,{style:{fontSize:"12px"},children:(v==null?void 0:v.desc)||"\u65E0\u63CF\u8FF0"})]})},De=function(s){return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"16px"},children:(0,r.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:"\u8F6C\u53D1\u6D88\u606F"})}),(0,r.jsx)(te.Z.List,{items:s.map(function(o,p){return{key:p,placement:"start",shape:"corner",content:Q(o.data.content,"start",null)}})})]})},Te=function(s){var o=c.useRef(null);return(0,c.useEffect)(function(){o.current&&window.DPlayer&&(o.current.innerHTML="",new window.DPlayer({container:o.current,video:{url:s},screenshot:!0}))},[s]),(0,r.jsx)("div",{ref:o,style:{maxWidth:"350px"}})},We=function(s){var o=(0,c.useState)(!0),p=x()(o,2),h=p[0],g=p[1];return s.startsWith("base64")&&(s="data:image/png;base64,"+s.split("base64://")[1]),(0,r.jsx)("div",{style:{width:"200px",maxWidth:"200px",cursor:"pointer",marginTop:"5px"},children:(0,r.jsx)(Y.Z,{spinning:h,children:(0,r.jsx)(re.Z,{src:s,onLoad:function(){return g(!1)}})})})},ke=function(s){return(0,r.jsx)("audio",{src:s,controls:!0,style:{width:"300px"}})},Ie=function(s){return s?(0,r.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"12px"},children:(0,r.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"4px"},children:s.length>50?"".concat(s.substring(0,50),"..."):s})}):null},ze=function(s,o){var p={uid:"1",name:o,url:s};return(0,r.jsx)("a",{style:{color:"inherit"},href:s,target:"_blank",download:o,children:(0,r.jsx)(be.Z.FileCard,{item:p})})},Ue=function(s,o){return(0,r.jsx)("div",{children:o=="start"?(0,r.jsx)("div",{dangerouslySetInnerHTML:{__html:Ee.render(s)}}):(0,r.jsx)("div",{children:s})})},Q=function(s,o,p){return s.map(function(h,g){var C,y,v,m,M;if(h.type=="text")return Ue(h.data.text,o);var S=(C=h.data)===null||C===void 0?void 0:C.file,b=S!=null&&S.startsWith("file")?"".concat(ae,"/api/chat/file?path=").concat(S):S;switch(h.type){case"music":return Le(h.data.type,(y=h.data)===null||y===void 0?void 0:y.id,(v=h.data)===null||v===void 0?void 0:v.audio,(m=h.data)===null||m===void 0?void 0:m.image,(M=h.data)===null||M===void 0?void 0:M.title);case"image":return We(b);case"video":return Te(b);case"record":return ke(b);case"reply":return Ie(p);case"at":return(0,r.jsx)("i",{style:{fontSize:12},children:o=="start"?"@\u4F60":"@\u673A\u5668\u4EBA"});default:return null}})},He=function(s){var o=s.role,p=s.replyContent,h=s.message_id,g=s.message;if((0,ne.isArray)(g))return Q(g,o,p||null);var C,y,v=g.action,m=(C=g.params)===null||C===void 0?void 0:C.messages,M=(y=g.params)===null||y===void 0?void 0:y.message;switch(v){case"send_group_forward_msg":if(m)return De(m);case"send_group_msg":if(M)return Q(M,o,p||null);case"upload_group_file":var S="".concat(ae,"/api/chat/file?path=").concat(g.params.file);return ze(S,g.params.name);default:return(0,r.jsx)("i",{style:{fontSize:"12px"},children:"\u672A\u5904\u7406\u4E8B\u4EF6\uFF1A".concat(v)})}},Pe=He,Oe="/api/ws",Ne=function(){var s,o=(0,c.useState)(!1),p=x()(o,2),h=p[0],g=p[1],C=(0,c.useState)(!1),y=x()(C,2),v=y[0],m=y[1],M=(0,c.useState)(!1),S=x()(M,2),b=S[0],z=S[1],X=(0,c.useState)(!1),D=x()(X,2),U=D[0],T=D[1],H=c.useRef(null),P=(0,Ze.useModel)("@@initialState"),E=P.initialState,w=P.setInitialState,se=E==null||(s=E.settings)===null||s===void 0?void 0:s.isDark,f=(0,c.useState)([]),ie=x()(f,2),O=ie[0],N=ie[1],$=(0,c.useRef)([]),le=(0,c.useRef)(null),Ge=(0,c.useState)(null),oe=x()(Ge,2),W=oe[0],Ve=oe[1],Ye=c.useState(!0),ue=x()(Ye,2),Ke=ue[0],de=ue[1],Qe=c.useState(!0),ce=x()(Qe,2),ve=ce[0],Xe=ce[1],J=(0,c.useRef)(null),$e=c.useRef(null),ct={};(0,c.useEffect)(function(){return qe(),function(){W&&W.close()}},[]),(0,c.useEffect)(function(){at(),$.current=O},[O]);var qe=function(){var d=k()(Z()().mark(function a(){var e,t,n,u,l,R,A;return Z()().wrap(function(j){for(;;)switch(j.prev=j.next){case 0:return j.prev=0,j.next=3,(0,L.$i)({start:0,end:999999});case 3:for(e=j.sent,t=[],n=e.data.length-1;n>=0;n--)u=e.data[n],Array.isArray(u)&&u.length===1&&(R=JSON.parse(u[0]),A=(l=R.message)!==null&&l!==void 0&&(l=l.params)!==null&&l!==void 0&&(l=l.message)!==null&&l!==void 0&&(l=l[0])!==null&&l!==void 0&&(l=l.data)!==null&&l!==void 0&&l.id?_e(t,R.message.params.message[0].data.id):null,R.replyContent=A,t.push(R));N(t),$.current=t,j.next=13;break;case 10:j.prev=10,j.t0=j.catch(0),B.ZP.error("\u5386\u53F2\u6D88\u606F\u52A0\u8F7D\u5931\u8D25: ".concat(j.t0));case 13:return j.prev=13,et(),j.finish(13);case 16:case"end":return j.stop()}},a,null,[[0,10,13,16]])}));return function(){return d.apply(this,arguments)}}(),_e=function(a,e){var t=a.find(function(l){return l.message_id==e}),n=(t==null?void 0:t.role)=="start"?t==null?void 0:t.message.params.message.at(-1):t==null?void 0:t.message.at(-1);if((n==null?void 0:n.type)=="text")return n.data.text;if(n!=null&&n.type){var u={image:"\u56FE\u7247",node:"\u8F6C\u53D1\u6D88\u606F",music:"\u97F3\u4E50",audio:"\u8BED\u97F3",video:"\u89C6\u9891",file:"\u6587\u4EF6"};return"[".concat(u[n.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},et=function d(){var a=new WebSocket("".concat(L.H9).concat(Oe,"?auth_token=").concat(localStorage.getItem("auth_token")));a.onopen=function(){de(!1)},a.onmessage=function(e){tt(e.data)},a.onclose=function(){window.location.pathname=="/chat"&&(de(!0),setTimeout(d,5e3))},a.onerror=function(e){B.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},Ve(a)},vt=function(){var d=k()(Z()().mark(function a(e){return Z()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",null);case 1:case"end":return n.stop()}},a)}));return function(e){return d.apply(this,arguments)}}(),tt=function(a){try{var e,t=JSON.parse(a);if(!t.message){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",t);return}var n=(e=t.message)!==null&&e!==void 0&&(e=e.params)!==null&&e!==void 0&&(e=e.message)!==null&&e!==void 0&&(e=e[0])!==null&&e!==void 0&&(e=e.data)!==null&&e!==void 0&&e.id?rt(t.message.params.message[0].data.id):null,u={role:(0,ne.isArray)(t==null?void 0:t.message)?"end":"start",replyContent:n,message_id:t.message_id,message:t.message};N(function(l){return l.some(function(R){return R.message_id===u.message_id})?l:[].concat(_()(l),[u])})}catch(l){console.warn(l)}},rt=function(a){var e=$.current.find(function(u){return u.message_id==a}),t=(e==null?void 0:e.role)=="start"?e==null?void 0:e.message.params.message.at(-1):e==null?void 0:e.message.at(-1);if((t==null?void 0:t.type)=="text")return t.data.text;if(t!=null&&t.type){var n={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(n[t.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},nt=function(a,e){var t={role:"end",message_id:e,message:a};N(function(n){return n.some(function(u){return u.message_id===t.message_id})?n:[].concat(_()(n),[t])})},at=function(){J.current&&(J.current.scrollTop=J.current.scrollHeight)},fe=function(a,e){if(a.trim())if(W&&W.readyState===WebSocket.OPEN){var t;g(!0);var n=Date.now(),u=[{msg_id:n},{type:e,data:e=="text"?{text:a}:{file:a}}];ve&&u.splice(1,0,{type:"at",data:{qq:"1000000",name:"Eridanus"}}),nt(u,n),W.send(JSON.stringify(u)),(t=H.current)===null||t===void 0||t.scrollTo({key:O.length-1,block:"nearest"}),setTimeout(function(){g(!1)},500)}else B.ZP.error("WebSocket \u672A\u8FDE\u63A5")},st=function(){var d=k()(Z()().mark(function a(){var e;return Z()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return z(!0),n.next=3,(0,L.qH)(null);case 3:e=n.sent,e!=null&&e.message?(N([]),B.ZP.success(e.message)):B.ZP.error(e==null?void 0:e.error),z(!1),T(!1);case 7:case"end":return n.stop()}},a)}));return function(){return d.apply(this,arguments)}}(),pe={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatCard:{width:"100%",height:"calc(100vh-100px)",display:"flex",flexDirection:"column"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",borderRadius:"12px",height:"auto",marginBottom:"115px",overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{position:"absolute",left:"0",bottom:"0px",backgroundColor:se?"#2e2e2e":"#fff",maxHeight:"50vh",overflowY:"auto"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}},it=function(a){return a.replace(/[^a-zA-Z0-9._-]/g,"_")},lt=B.ZP.useMessage(),he=x()(lt,2),ge=he[0],ot=he[1],G=function(a,e,t,n){var u=it(n);a<100?ge.open({key:u,type:"loading",content:"\u6B63\u5728\u4E0A\u4F20: ".concat(a,"%"),duration:0}):e&&ge.open({key:u,type:t?"success":"error",content:t?"".concat(n," \u4E0A\u4F20\u6210\u529F"):"".concat(n," \u4E0A\u4F20\u5931\u8D25"),duration:2})};return(0,r.jsx)(Y.Z,{spinning:Ke,tip:"WebSocket\u8FDE\u63A5\u4E2D...",size:"large",children:(0,r.jsxs)(je.Z,{style:{height:"calc(100vh - 100px)"},children:[ot,(0,r.jsxs)("div",{ref:$e,style:{width:"100%",height:"calc(100vh - 100px)",display:"flex",flexDirection:"column"},children:[(0,r.jsx)("div",{style:pe.chatContainer,ref:J,children:(0,r.jsx)(te.Z.List,{ref:H,items:O.map(function(d,a){return{key:a,placement:d.role,shape:"corner",content:(0,r.jsx)(Pe,{role:d.role,replyContent:d.replyContent,message:d.message,message_id:d.message_id},a)}})})}),(0,r.jsx)(Ae.Z,{ref:le,loading:h,placeholder:"\u8BF7\u8F93\u5165...",style:pe.bottomTools,autoSize:{maxRows:8},onSubmit:function(a){var e,t;fe(a,"text"),(e=le.current)===null||e===void 0||(t=e.clear)===null||t===void 0||t.call(e)},footer:function(a){return(0,r.jsxs)(K.Z,{justify:"space-between",align:"center",children:[(0,r.jsxs)(K.Z,{gap:"small",align:"center",children:[(0,r.jsx)(Ce.Z,{accept:"image/*",pastable:!0,name:"file",action:"".concat(L.H9,"/api/chat/uploadFile"),onChange:function(t){m(!0);var n=t.file.name;if(t.file.status=="uploading"){var u,l;G(Math.floor((u=(l=t.event)===null||l===void 0?void 0:l.percent)!==null&&u!==void 0?u:0),!1,!1,n)}if(t.file.status==="done"){var R;console.log(t.file.response);var A=t.file.response;if(A!=null&&(R=A.files[0])!==null&&R!==void 0&&R.error)G(100,!0,!1,n),m(!1);else{var V;fe(A==null||(V=A.files[0])===null||V===void 0?void 0:V.path,"image"),G(100,!0,!0,n),m(!1)}}else t.file.status==="error"&&(G(100,!0,!1,n),m(!1))},maxCount:1,multiple:!1,showUploadList:!1,children:(0,r.jsx)(ee.ZP,{disabled:v,type:"text",icon:(0,r.jsx)(Me.Z,{})})}),(0,r.jsx)(ee.ZP,{type:"text",onClick:function(){return T(!0)},icon:(0,r.jsx)(we.Z,{})}),(0,r.jsx)(Re.Z,{title:"\u63D0\u793A",open:U,onOk:function(){return st()},confirmLoading:b,onCancel:function(){return T(!1)},children:(0,r.jsx)("p",{children:"\u786E\u8BA4\u6E05\u7A7A\u804A\u5929\u8BB0\u5F55\u5417\uFF1F\u804A\u5929\u6587\u4EF6\u4E0D\u4F1A\u88AB\u5220\u9664\u3002"})}),"@\u673A\u5668\u4EBA",(0,r.jsx)(Fe.Z,{size:"small",checked:ve,onChange:function(t){Xe(t)}})]}),(0,r.jsx)(K.Z,{align:"center",children:a})]})},suffix:!1})]})]})})},Je=Ne}}]);
