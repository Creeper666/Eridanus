"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{43151:function(Be,J,r){var le=r(97857),I=r.n(le),oe=r(13769),E=r.n(oe),ue=r(67294),D=r(31093),G=r(85893),h=["children","type","delay","duration","className","style","component"],o=function(y){var B=100;switch(y){case"top":return{hidden:{opacity:0,y:-B},visible:{opacity:1,y:0}};case"bottom":return{hidden:{opacity:0,y:B},visible:{opacity:1,y:0}};case"left":return{hidden:{opacity:0,x:-B},visible:{opacity:1,x:0}};case"right":return{hidden:{opacity:0,x:B},visible:{opacity:1,x:0}};case"scale":return{hidden:{opacity:0,scale:.8},visible:{opacity:1,scale:1}};case"alpha":default:return{hidden:{opacity:0},visible:{opacity:1}}}},F=function(y){var B=y.children,U=y.type,z=U===void 0?"right":U,Q=y.delay,de=Q===void 0?0:Q,X=y.duration,Y=X===void 0?500:X,ce=y.className,ve=y.style,w=y.component,H=w===void 0?"div":w,fe=E()(y,h),P=ue.Children.toArray(B),pe=Array.isArray(z)?z[0]:z,me=o(pe),he=D.E[H]||(0,D.E)(H);return(0,G.jsx)(he,I()(I()({className:ce,style:ve},fe),{},{children:P.map(function(N,$){var n=(de+$*100)/1e3,ge=Y/1e3;return(0,G.jsx)(D.E.div,{initial:me.hidden,animate:me.visible,transition:{delay:n,duration:ge,ease:"backOut"},children:N},N.key||$)})}))};J.Z=F},30778:function(Be,J,r){r.r(J),r.d(J,{default:function(){return Je}});var le=r(19632),I=r.n(le),oe=r(15009),E=r.n(oe),ue=r(99289),D=r.n(ue),G=r(5574),h=r.n(G),o=r(67294),F=r(2453),O=r(74330),y=r(86250),B=r(99842),U=r(71577),z=r(88556),Q=r(57478),de=r(16596),X=r(82061),Y=r(63254),ce=r(2987),ve=r(84226),w=r(34586),H=r(68627),fe=r(16027),P=r(2618),pe=r(69404),me=r(63334),he=r(1469),N=r.n(he),$=r(19050),n=r(85893),ge=function(i,u,g,p,m){var C=(0,o.useState)(null),S=h()(C,2),v=S[0],x=S[1],A=(0,o.useState)(!0),j=h()(A,2),W=j[0],q=j[1],xe=(0,o.useState)(null),k=h()(xe,2),_=k[0],K=k[1];return(0,o.useEffect)(function(){var ee=function(){var te=D()(E()().mark(function T(){var L;return E()().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(f.prev=0,i!="custom"){f.next=6;break}x({desc:"",musicUrl:g,title:m,preview:p}),window.dispatchEvent(new CustomEvent("add-to-playlist",{detail:{name:m||"\u672A\u77E5\u6807\u9898",artist:"",url:g||"",cover:p||"https://picsum.photos/128/128"}})),f.next=13;break;case 6:return f.next=8,(0,P.Hv)({type:i,id:u});case 8:if(L=f.sent,!L.error){f.next=11;break}throw new Error(L.error);case 11:x(L),window.dispatchEvent(new CustomEvent("add-to-playlist",{detail:{name:L.title||"\u672A\u77E5\u6807\u9898",artist:L.desc||"\u65E0\u63CF\u8FF0",url:L.musicUrl||"",cover:L.preview||"https://picsum.photos/128/128"}}));case 13:f.next=18;break;case 15:f.prev=15,f.t0=f.catch(0),K(f.t0||"\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25");case 18:return f.prev=18,q(!1),f.finish(18);case 21:case"end":return f.stop()}},T,null,[[0,15,18,21]])}));return function(){return te.apply(this,arguments)}}();ee()},[i,u]),W?(0,n.jsx)(O.Z,{style:{width:100,height:150,maxWidth:"100%",display:"flex",justifyContent:"center",alignItems:"center"}}):_?(0,n.jsx)("div",{children:_}):(0,n.jsxs)(w.Z,{direction:"vertical",style:{alignItems:"center",rowGap:0,width:100},children:[(0,n.jsx)(w.Z,{children:(0,n.jsx)(H.Z,{src:(v==null?void 0:v.preview)||"https://picsum.photos/128/128",width:100,style:{borderRadius:"5px"}})}),(0,n.jsx)(w.Z,{style:{fontSize:"16px",fontWeight:"bold"},children:(v==null?void 0:v.title)||"\u672A\u77E5\u6807\u9898"}),(0,n.jsx)(w.Z,{style:{fontSize:"12px"},children:(v==null?void 0:v.desc)||"\u65E0\u63CF\u8FF0"})]})},we=function(i){return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{style:{backgroundColor:"transparent",borderRadius:"4px",fontSize:"16px"},children:(0,n.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:"\u8F6C\u53D1\u6D88\u606F"})}),(0,n.jsx)(Y.Z.List,{items:i.map(function(u,g){return{key:g,placement:"start",shape:"corner",content:ye(u.data.content,"start",null)}})})]})},We=function(i){var u=o.useRef(null);return(0,o.useEffect)(function(){u.current&&window.DPlayer&&(u.current.innerHTML="",new window.DPlayer({container:u.current,video:{url:i},screenshot:!0}))},[i]),(0,n.jsx)("div",{ref:u,style:{maxWidth:"350px"}})},Te=function(i){var u=(0,o.useState)(!0),g=h()(u,2),p=g[0],m=g[1];return i.startsWith("base64")&&(i="data:image/png;base64,"+i.split("base64://")[1]),(0,n.jsx)("div",{style:{width:"200px",maxWidth:"200px",cursor:"pointer",marginTop:"5px"},children:(0,n.jsx)(O.Z,{spinning:p,children:(0,n.jsx)(H.Z,{src:i,onLoad:function(){return m(!1)}})})})},Ie=function(i){return(0,n.jsx)("audio",{src:i,controls:!0,style:{width:"300px"}})},Oe=function(i){return i?(0,n.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"12px"},children:(0,n.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"4px"},children:i.length>50?"".concat(i.substring(0,50),"..."):i})}):null},Ue=function(i,u){return(0,n.jsx)("a",{style:{color:"inherit"},href:i,target:"_blank",download:u,children:(0,n.jsx)(pe.Z,{name:u,mask:(0,n.jsx)($.Z,{})})})},ze=function(i,u){return(0,n.jsx)("div",{children:u=="start"?(0,n.jsx)(fe.Z,{content:i.replace(/\n/g,`

`)}):(0,n.jsx)("div",{children:i})})},ye=function(i,u,g){return i.map(function(p,m){var C,S,v,x,A;if(p.type=="text")return ze(p.data.text,u);var j=(C=p.data)===null||C===void 0?void 0:C.file,W=j!=null&&j.startsWith("file")?"".concat(P.H9,"/api/chat/file?path=").concat(j):j;switch(p.type){case"music":return ge(p.data.type,(S=p.data)===null||S===void 0?void 0:S.id,(v=p.data)===null||v===void 0?void 0:v.audio,(x=p.data)===null||x===void 0?void 0:x.image,(A=p.data)===null||A===void 0?void 0:A.title);case"image":return Te(W);case"video":return We(W);case"record":return Ie(W);case"reply":return Oe(g);case"at":return(0,n.jsx)("i",{style:{fontSize:12},children:u=="start"?"@\u4F60":"@\u673A\u5668\u4EBA"});default:return null}})},He=function(i){var u=i.role,g=i.replyContent,p=i.message_id,m=i.message;if(N()(m))return ye(m,u,g||null);var C,S,v=m.action,x=(C=m.params)===null||C===void 0?void 0:C.messages,A=(S=m.params)===null||S===void 0?void 0:S.message;switch(v){case"send_group_forward_msg":if(x)return we(x);case"send_group_msg":if(A)return ye(A,u,g||null);case"upload_group_file":var j="".concat(P.H9,"/api/chat/file?path=").concat(m.params.file);return Ue(j,m.params.name);default:return(0,n.jsx)("i",{style:{fontSize:"12px"},children:"\u672A\u5904\u7406\u4E8B\u4EF6\uFF1A".concat(v)})}},Ne=He,ke=r(43151),Ke="/api/ws",Ve=function(){var i,u=(0,o.useState)(!1),g=h()(u,2),p=g[0],m=g[1],C=(0,o.useState)(!1),S=h()(C,2),v=S[0],x=S[1],A=(0,o.useState)(!1),j=h()(A,2),W=j[0],q=j[1],xe=(0,o.useState)(!1),k=h()(xe,2),_=k[0],K=k[1],ee=o.useRef(null),te=(0,ve.useModel)("@@initialState"),T=te.initialState,L=te.setInitialState,Se=T==null||(i=T.settings)===null||i===void 0?void 0:i.isDark,f=(0,o.useState)([]),be=h()(f,2),ne=be[0],ae=be[1],je=(0,o.useRef)([]),Ce=(0,o.useRef)(null),Ge=(0,o.useState)(null),Ze=h()(Ge,2),V=Ze[0],Qe=Ze[1],Xe=o.useState(!0),Ee=h()(Xe,2),Ye=Ee[0],Me=Ee[1],$e=o.useState(!0),Ae=h()($e,2),Pe=Ae[0],qe=Ae[1],re=(0,o.useRef)(null),_e=o.useRef(null),ct={};(0,o.useEffect)(function(){return et(),function(){V&&V.close()}},[]),(0,o.useEffect)(function(){it(),je.current=ne},[ne]);var et=function(){var c=D()(E()().mark(function s(){var e,t,a,d,l,Z,R;return E()().wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.prev=0,b.next=3,(0,P.$i)({start:0,end:999999});case 3:for(e=b.sent,t=[],a=e.data.length-1;a>=0;a--)d=e.data[a],Array.isArray(d)&&d.length===1&&(Z=JSON.parse(d[0]),R=(l=Z.message)!==null&&l!==void 0&&(l=l.params)!==null&&l!==void 0&&(l=l.message)!==null&&l!==void 0&&(l=l[0])!==null&&l!==void 0&&(l=l.data)!==null&&l!==void 0&&l.id?tt(t,Z.message.params.message[0].data.id):null,Z.replyContent=R,t.push(Z));ae(t),je.current=t,b.next=13;break;case 10:b.prev=10,b.t0=b.catch(0),F.ZP.error("\u5386\u53F2\u6D88\u606F\u52A0\u8F7D\u5931\u8D25: ".concat(b.t0));case 13:return b.prev=13,nt(),b.finish(13);case 16:case"end":return b.stop()}},s,null,[[0,10,13,16]])}));return function(){return c.apply(this,arguments)}}(),tt=function(s,e){var t=s.find(function(l){return l.message_id==e}),a=(t==null?void 0:t.role)=="start"?t==null?void 0:t.message.params.message.at(-1):t==null?void 0:t.message.at(-1);if((a==null?void 0:a.type)=="text")return a.data.text;if(a!=null&&a.type){var d={image:"\u56FE\u7247",node:"\u8F6C\u53D1\u6D88\u606F",music:"\u97F3\u4E50",audio:"\u8BED\u97F3",video:"\u89C6\u9891",file:"\u6587\u4EF6"};return"[".concat(d[a.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},nt=function c(){var s=new WebSocket("".concat(P.H9).concat(Ke,"?auth_token=").concat(localStorage.getItem("auth_token")));s.onopen=function(){Me(!1)},s.onmessage=function(e){at(e.data)},s.onclose=function(){window.location.pathname=="/chat"&&(Me(!0),setTimeout(c,5e3))},s.onerror=function(e){F.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},Qe(s)},vt=function(){var c=D()(E()().mark(function s(e){return E()().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",null);case 1:case"end":return a.stop()}},s)}));return function(e){return c.apply(this,arguments)}}(),at=function(s){try{var e,t=JSON.parse(s);if(!t.message){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",t);return}var a=(e=t.message)!==null&&e!==void 0&&(e=e.params)!==null&&e!==void 0&&(e=e.message)!==null&&e!==void 0&&(e=e[0])!==null&&e!==void 0&&(e=e.data)!==null&&e!==void 0&&e.id?rt(t.message.params.message[0].data.id):null,d={role:N()(t==null?void 0:t.message)?"end":"start",replyContent:a,message_id:t.message_id,message:t.message};ae(function(l){return l.some(function(Z){return Z.message_id===d.message_id})?l:[].concat(I()(l),[d])})}catch(l){console.warn(l)}},rt=function(s){var e=je.current.find(function(d){return d.message_id==s}),t=(e==null?void 0:e.role)=="start"?e==null?void 0:e.message.params.message.at(-1):e==null?void 0:e.message.at(-1);if((t==null?void 0:t.type)=="text")return t.data.text;if(t!=null&&t.type){var a={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(a[t.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},st=function(s,e){var t={role:"end",message_id:e,message:s};ae(function(a){return a.some(function(d){return d.message_id===t.message_id})?a:[].concat(I()(a),[t])})},it=function(){re.current&&(re.current.scrollTop=re.current.scrollHeight)},Le=function(s,e){if(s.trim())if(V&&V.readyState===WebSocket.OPEN){var t;m(!0);var a=Date.now(),d=[{msg_id:a},{type:e,data:e=="text"?{text:s}:{file:s}}];Pe&&d.splice(1,0,{type:"at",data:{qq:"1000000",name:"Eridanus"}}),st(d,a),V.send(JSON.stringify(d)),(t=ee.current)===null||t===void 0||t.scrollTo({key:ne.length-1,block:"nearest"}),setTimeout(function(){m(!1)},500)}else F.ZP.error("WebSocket \u672A\u8FDE\u63A5")},lt=function(){var c=D()(E()().mark(function s(){var e;return E()().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return q(!0),a.next=3,(0,P.qH)(null);case 3:e=a.sent,e!=null&&e.message?(ae([]),F.ZP.success(e.message)):F.ZP.error(e==null?void 0:e.error),q(!1),K(!1);case 7:case"end":return a.stop()}},s)}));return function(){return c.apply(this,arguments)}}(),Re={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",padding:"5px",flex:1,overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{backgroundColor:Se?"#2e2e2e":"#fff",borderTop:Se?"1px solid #444":"1px solid #f0f0f0",padding:"10px 0"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}},ot=function(s){return s.replace(/[^a-zA-Z0-9._-]/g,"_")},ut=F.ZP.useMessage(),De=h()(ut,2),Fe=De[0],dt=De[1],se=function(s,e,t,a){var d=ot(a);s<100?Fe.open({key:d,type:"loading",content:"\u6B63\u5728\u4E0A\u4F20: ".concat(s,"%"),duration:0}):e&&Fe.open({key:d,type:t?"success":"error",content:t?"".concat(a," \u4E0A\u4F20\u6210\u529F"):"".concat(a," \u4E0A\u4F20\u5931\u8D25"),duration:2})};return(0,n.jsx)(ke.Z,{type:"bottom",delay:100,children:(0,n.jsxs)(O.Z,{spinning:Ye,tip:"WebSocket\u8FDE\u63A5\u4E2D...",size:"large",children:[dt,(0,n.jsxs)("div",{ref:_e,style:{width:"100%",height:"calc(100dvh - 80px)",display:"flex",flexDirection:"column"},children:[(0,n.jsx)("div",{style:Re.chatContainer,ref:re,children:(0,n.jsx)(Y.Z.List,{ref:ee,items:ne.map(function(c,s){return{key:s,placement:c.role,shape:"corner",content:(0,n.jsx)(Ne,{role:c.role,replyContent:c.replyContent,message:c.message,message_id:c.message_id},s)}})})}),(0,n.jsx)(ce.Z,{ref:Ce,loading:p,style:Re.bottomTools,placeholder:"\u8BF7\u8F93\u5165...",autoSize:{maxRows:8},onSubmit:function(s){var e,t;Le(s,"text"),(e=Ce.current)===null||e===void 0||(t=e.clear)===null||t===void 0||t.call(e)},footer:function(s){return(0,n.jsxs)(y.Z,{justify:"space-between",align:"center",children:[(0,n.jsxs)(y.Z,{gap:"small",align:"center",children:[(0,n.jsx)(B.Z,{accept:"image/*",pastable:!0,name:"file",action:"".concat(P.H9,"/api/chat/uploadFile"),onChange:function(t){x(!0);var a=t.file.name;if(t.file.status=="uploading"){var d,l;se(Math.floor((d=(l=t.event)===null||l===void 0?void 0:l.percent)!==null&&d!==void 0?d:0),!1,!1,a)}if(t.file.status==="done"){var Z;console.log(t.file.response);var R=t.file.response;if(R!=null&&(Z=R.files[0])!==null&&Z!==void 0&&Z.error)se(100,!0,!1,a),x(!1);else{var ie;Le(R==null||(ie=R.files[0])===null||ie===void 0?void 0:ie.path,"image"),se(100,!0,!0,a),x(!1)}}else t.file.status==="error"&&(se(100,!0,!1,a),x(!1))},maxCount:1,multiple:!1,showUploadList:!1,children:(0,n.jsx)(U.ZP,{disabled:v,type:"text",icon:(0,n.jsx)(de.Z,{})})}),(0,n.jsx)(U.ZP,{type:"text",onClick:function(){return K(!0)},icon:(0,n.jsx)(X.Z,{})}),(0,n.jsx)(z.Z,{title:"\u63D0\u793A",open:_,onOk:function(){return lt()},confirmLoading:W,onCancel:function(){return K(!1)},children:(0,n.jsx)("p",{children:"\u786E\u8BA4\u6E05\u7A7A\u804A\u5929\u8BB0\u5F55\u5417\uFF1F\u804A\u5929\u6587\u4EF6\u4E0D\u4F1A\u88AB\u5220\u9664\u3002"})}),"@\u673A\u5668\u4EBA",(0,n.jsx)(Q.Z,{size:"small",checked:Pe,onChange:function(t){qe(t)}})]}),(0,n.jsx)(y.Z,{align:"center",children:s})]})},suffix:!1})]})]})})},Je=Ve}}]);
