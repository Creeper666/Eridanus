"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{43151:function(Oe,J,a){var ue=a(97857),I=a.n(ue),de=a(13769),Z=a.n(de),ce=a(67294),F=a(31093),G=a(85893),m=["children","type","delay","duration","className","style","component"],o=function(y){var A=100;switch(y){case"top":return{hidden:{opacity:0,y:-A},visible:{opacity:1,y:0}};case"bottom":return{hidden:{opacity:0,y:A},visible:{opacity:1,y:0}};case"left":return{hidden:{opacity:0,x:-A},visible:{opacity:1,x:0}};case"right":return{hidden:{opacity:0,x:A},visible:{opacity:1,x:0}};case"scale":return{hidden:{opacity:0,scale:.8},visible:{opacity:1,scale:1}};case"alpha":default:return{hidden:{opacity:0},visible:{opacity:1}}}},B=function(y){var A=y.children,Q=y.type,U=Q===void 0?"right":Q,X=y.delay,ve=X===void 0?0:X,Y=y.duration,$=Y===void 0?500:Y,fe=y.className,pe=y.style,w=y.component,k=w===void 0?"div":w,me=Z()(y,m),P=ce.Children.toArray(A),he=Array.isArray(U)?U[0]:U,ge=o(he),ye=F.E[k]||(0,F.E)(k);return(0,G.jsx)(ye,I()(I()({className:fe,style:pe},me),{},{children:P.map(function(z,_){var r=(ve+_*100)/1e3,xe=$/1e3;return(0,G.jsx)(F.E.div,{initial:ge.hidden,animate:ge.visible,transition:{delay:r,duration:xe,ease:"backOut"},children:z},z.key||_)})}))};J.Z=B},30778:function(Oe,J,a){a.r(J),a.d(J,{default:function(){return $e}});var ue=a(19632),I=a.n(ue),de=a(15009),Z=a.n(de),ce=a(99289),F=a.n(ce),G=a(5574),m=a.n(G),o=a(67294),B=a(2453),O=a(71577),y=a(74330),A=a(86250),Q=a(99842),U=a(88556),X=a(57478),ve=a(16596),Y=a(82061),$=a(63254),fe=a(2987),pe=a(84226),w=a(34586),k=a(68627),me=a(16027),P=a(2618),he=a(69404),ge=a(63334),ye=a(1469),z=a.n(ye),_=a(19050),r=a(85893),xe=function(i,u,g,p,h){var j=(0,o.useState)(null),S=m()(j,2),v=S[0],x=S[1],M=(0,o.useState)(!0),C=m()(M,2),W=C[0],q=C[1],Ce=(0,o.useState)(null),H=m()(Ce,2),ee=H[0],N=H[1];return(0,o.useEffect)(function(){var te=function(){var re=F()(Z()().mark(function T(){var R;return Z()().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(f.prev=0,i!="custom"){f.next=6;break}x({desc:"",musicUrl:g,title:h,preview:p}),window.dispatchEvent(new CustomEvent("add-to-playlist",{detail:{name:h||"\u672A\u77E5\u6807\u9898",artist:"",url:g||"",cover:p||"https://picsum.photos/128/128"}})),f.next=13;break;case 6:return f.next=8,(0,P.Hv)({type:i,id:u});case 8:if(R=f.sent,!R.error){f.next=11;break}throw new Error(R.error);case 11:x(R),window.dispatchEvent(new CustomEvent("add-to-playlist",{detail:{name:R.title||"\u672A\u77E5\u6807\u9898",artist:R.desc||"\u65E0\u63CF\u8FF0",url:R.musicUrl||"",cover:R.preview||"https://picsum.photos/128/128"}}));case 13:f.next=18;break;case 15:f.prev=15,f.t0=f.catch(0),N(f.t0||"\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25");case 18:return f.prev=18,q(!1),f.finish(18);case 21:case"end":return f.stop()}},T,null,[[0,15,18,21]])}));return function(){return re.apply(this,arguments)}}();te()},[i,u]),W?(0,r.jsx)(y.Z,{style:{width:100,height:150,maxWidth:"100%",display:"flex",justifyContent:"center",alignItems:"center"}}):ee?(0,r.jsx)("div",{children:ee}):(0,r.jsxs)(w.Z,{direction:"vertical",style:{alignItems:"center",rowGap:0,width:100},children:[(0,r.jsx)(w.Z,{children:(0,r.jsx)(k.Z,{src:(v==null?void 0:v.preview)||"https://picsum.photos/128/128",width:100,style:{borderRadius:"5px"}})}),(0,r.jsx)(w.Z,{style:{fontSize:"16px",fontWeight:"bold"},children:(v==null?void 0:v.title)||"\u672A\u77E5\u6807\u9898"}),(0,r.jsx)(w.Z,{style:{fontSize:"12px"},children:(v==null?void 0:v.desc)||"\u65E0\u63CF\u8FF0"})]})},Ue=function(i){return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{style:{backgroundColor:"transparent",borderRadius:"4px",fontSize:"16px"},children:(0,r.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:"\u8F6C\u53D1\u6D88\u606F"})}),(0,r.jsx)($.Z.List,{items:i.map(function(u,g){return{key:g,placement:"start",shape:"corner",content:Se(u.data.content,"start",null)}})})]})},ke=function(i){var u=o.useRef(null);return(0,o.useEffect)(function(){u.current&&window.DPlayer&&(u.current.innerHTML="",new window.DPlayer({container:u.current,video:{url:i},screenshot:!0}))},[i]),(0,r.jsx)("div",{ref:u,style:{maxWidth:"350px"}})},ze=function(i){var u=(0,o.useState)(!0),g=m()(u,2),p=g[0],h=g[1];return i.startsWith("base64")&&(i="data:image/png;base64,"+i.split("base64://")[1]),(0,r.jsx)("div",{style:{width:"200px",maxWidth:"200px",cursor:"pointer",marginTop:"5px"},children:(0,r.jsx)(y.Z,{spinning:p,children:(0,r.jsx)(k.Z,{src:i,onLoad:function(){return h(!1)}})})})},He=function(i){return(0,r.jsx)("audio",{src:i,controls:!0,style:{width:"300px"}})},Ne=function(i){return i?(0,r.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"12px"},children:(0,r.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"4px"},children:i.length>50?"".concat(i.substring(0,50),"..."):i})}):null},Ke=function(i,u){return(0,r.jsx)("a",{style:{color:"inherit"},href:i,target:"_blank",download:u,children:(0,r.jsx)(he.Z,{name:u,mask:(0,r.jsx)(_.Z,{})})})},Ve=function(i,u){return(0,r.jsx)("div",{children:u=="start"?(0,r.jsx)(me.Z,{content:i.replace(/\n/g,`

`)}):(0,r.jsx)("div",{children:i})})},Se=function(i,u,g){return i.map(function(p,h){var j,S,v,x,M;if(p.type=="text")return Ve(p.data.text,u);var C=(j=p.data)===null||j===void 0?void 0:j.file,W=C!=null&&C.startsWith("file")?"".concat(P.H9,"/api/chat/file?path=").concat(C):C;switch(p.type){case"music":return xe(p.data.type,(S=p.data)===null||S===void 0?void 0:S.id,(v=p.data)===null||v===void 0?void 0:v.audio,(x=p.data)===null||x===void 0?void 0:x.image,(M=p.data)===null||M===void 0?void 0:M.title);case"image":return ze(W);case"video":return ke(W);case"record":return He(W);case"reply":return Ne(g);case"at":return(0,r.jsx)("i",{style:{fontSize:12},children:u=="start"?"@\u4F60":"@\u673A\u5668\u4EBA"});default:return null}})},Je=function(i){var u=i.role,g=i.replyContent,p=i.message_id,h=i.message;if(z()(h))return Se(h,u,g||null);var j,S,v=h.action,x=(j=h.params)===null||j===void 0?void 0:j.messages,M=(S=h.params)===null||S===void 0?void 0:S.message;switch(v){case"send_group_forward_msg":if(x)return Ue(x);case"send_group_msg":if(M)return Se(M,u,g||null);case"upload_group_file":var C="".concat(P.H9,"/api/chat/file?path=").concat(h.params.file);return Ke(C,h.params.name);default:return(0,r.jsx)("i",{style:{fontSize:"12px"},children:"\u672A\u5904\u7406\u4E8B\u4EF6\uFF1A".concat(v)})}},Ge=Je,Qe=a(43151),Xe="/api/ws",Ye=function(){var i,u=(0,o.useState)(!1),g=m()(u,2),p=g[0],h=g[1],j=(0,o.useState)(!1),S=m()(j,2),v=S[0],x=S[1],M=(0,o.useState)(!1),C=m()(M,2),W=C[0],q=C[1],Ce=(0,o.useState)(!1),H=m()(Ce,2),ee=H[0],N=H[1],te=o.useRef(null),re=(0,pe.useModel)("@@initialState"),T=re.initialState,R=re.setInitialState,K=T==null||(i=T.settings)===null||i===void 0?void 0:i.isDark,f=(0,o.useState)([]),Ee=m()(f,2),ne=Ee[0],ae=Ee[1],be=(0,o.useRef)([]),Ze=(0,o.useRef)(null),_e=(0,o.useState)(null),Ae=m()(_e,2),V=Ae[0],qe=Ae[1],et=o.useState(!0),De=m()(et,2),tt=De[0],Me=De[1],rt=o.useState(!0),Pe=m()(rt,2),Re=Pe[0],nt=Pe[1],se=(0,o.useRef)(null),at=o.useRef(null),st=(0,o.useState)(0),Le=m()(st,2),it=Le[0],je=Le[1],ie=(0,o.useRef)(0),Fe=1,gt={};(0,o.useEffect)(function(){return lt(),function(){V&&V.close()}},[]),(0,o.useEffect)(function(){vt(),be.current=ne},[ne]);var lt=function(){var d=F()(Z()().mark(function s(){var e,t,n,c,l,E,L;return Z()().wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.prev=0,b.next=3,(0,P.$i)({start:0,end:999999});case 3:for(e=b.sent,t=[],n=e.data.length-1;n>=0;n--)c=e.data[n],Array.isArray(c)&&c.length===1&&(E=JSON.parse(c[0]),L=(l=E.message)!==null&&l!==void 0&&(l=l.params)!==null&&l!==void 0&&(l=l.message)!==null&&l!==void 0&&(l=l[0])!==null&&l!==void 0&&(l=l.data)!==null&&l!==void 0&&l.id?ot(t,E.message.params.message[0].data.id):null,E.replyContent=L,t.push(E));ae(t),be.current=t,b.next=13;break;case 10:b.prev=10,b.t0=b.catch(0),B.ZP.error("\u5386\u53F2\u6D88\u606F\u52A0\u8F7D\u5931\u8D25: ".concat(b.t0));case 13:return b.prev=13,Be(),b.finish(13);case 16:case"end":return b.stop()}},s,null,[[0,10,13,16]])}));return function(){return d.apply(this,arguments)}}(),ot=function(s,e){var t=s.find(function(l){return l.message_id==e}),n=(t==null?void 0:t.role)=="start"?t==null?void 0:t.message.params.message.at(-1):t==null?void 0:t.message.at(-1);if((n==null?void 0:n.type)=="text")return n.data.text;if(n!=null&&n.type){var c={image:"\u56FE\u7247",node:"\u8F6C\u53D1\u6D88\u606F",music:"\u97F3\u4E50",audio:"\u8BED\u97F3",video:"\u89C6\u9891",file:"\u6587\u4EF6"};return"[".concat(c[n.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},Be=function d(){var s=new WebSocket("".concat(P.H9).concat(Xe,"?auth_token=").concat(localStorage.getItem("auth_token")));s.onopen=function(){Me(!1),ie.current=0,je(0)},s.onmessage=function(e){ut(e.data)},s.onclose=function(){window.location.pathname=="/chat"&&ie.current<Fe&&(Me(!0),setTimeout(d,5e3))},s.onerror=function(e){ie.current+=1,je(ie.current),B.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},qe(s)},yt=function(){var d=F()(Z()().mark(function s(e){return Z()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",null);case 1:case"end":return n.stop()}},s)}));return function(e){return d.apply(this,arguments)}}(),ut=function(s){try{var e,t=JSON.parse(s);if(!t.message){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",t);return}var n=(e=t.message)!==null&&e!==void 0&&(e=e.params)!==null&&e!==void 0&&(e=e.message)!==null&&e!==void 0&&(e=e[0])!==null&&e!==void 0&&(e=e.data)!==null&&e!==void 0&&e.id?dt(t.message.params.message[0].data.id):null,c={role:z()(t==null?void 0:t.message)?"end":"start",replyContent:n,message_id:t.message_id,message:t.message};ae(function(l){return l.some(function(E){return E.message_id===c.message_id})?l:[].concat(I()(l),[c])})}catch(l){console.warn(l)}},dt=function(s){var e=be.current.find(function(c){return c.message_id==s}),t=(e==null?void 0:e.role)=="start"?e==null?void 0:e.message.params.message.at(-1):e==null?void 0:e.message.at(-1);if((t==null?void 0:t.type)=="text")return t.data.text;if(t!=null&&t.type){var n={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(n[t.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},ct=function(s,e){var t={role:"end",message_id:e,message:s};ae(function(n){return n.some(function(c){return c.message_id===t.message_id})?n:[].concat(I()(n),[t])})},vt=function(){se.current&&(se.current.scrollTop=se.current.scrollHeight)},we=function(s,e){if(s.trim())if(V&&V.readyState===WebSocket.OPEN){var t;h(!0);var n=Date.now(),c=[{msg_id:n},{type:e,data:e=="text"?{text:s}:{file:s}}];Re&&c.splice(1,0,{type:"at",data:{qq:"1000000",name:"Eridanus"}}),ct(c,n),V.send(JSON.stringify(c)),(t=te.current)===null||t===void 0||t.scrollTo({key:ne.length-1,block:"nearest"}),setTimeout(function(){h(!1)},500)}else B.ZP.error("WebSocket \u672A\u8FDE\u63A5")},ft=function(){var d=F()(Z()().mark(function s(){var e;return Z()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return q(!0),n.next=3,(0,P.qH)(null);case 3:e=n.sent,e!=null&&e.message?(ae([]),B.ZP.success(e.message)):B.ZP.error(e==null?void 0:e.error),q(!1),N(!1);case 7:case"end":return n.stop()}},s)}));return function(){return d.apply(this,arguments)}}(),We={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",padding:"5px",flex:1,overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{backgroundColor:K?"#2e2e2e":"#fff",borderTop:K?"1px solid #444":"1px solid #f0f0f0",padding:"10px 0"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}},pt=function(s){return s.replace(/[^a-zA-Z0-9._-]/g,"_")},mt=B.ZP.useMessage(),Te=m()(mt,2),Ie=Te[0],ht=Te[1],le=function(s,e,t,n){var c=pt(n);s<100?Ie.open({key:c,type:"loading",content:"\u6B63\u5728\u4E0A\u4F20: ".concat(s,"%"),duration:0}):e&&Ie.open({key:c,type:t?"success":"error",content:t?"".concat(n," \u4E0A\u4F20\u6210\u529F"):"".concat(n," \u4E0A\u4F20\u5931\u8D25"),duration:2})};return(0,r.jsxs)(Qe.Z,{type:"bottom",delay:100,children:[(0,r.jsxs)("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:K?"#fff":"#000",backgroundColor:K?"#2e2e2e":"#fff",padding:"20px",borderRadius:"8px",boxShadow:"0 0 10px rgba(0, 0, 0, 0.5)",textAlign:"center",visibility:it>=Fe?"visible":"hidden",zIndex:500},children:[(0,r.jsx)("p",{children:"Websocket\u91CD\u8FDE\u51FA\u9519\uFF0C\u8BF7\u5C1D\u8BD5\u518D\u6B21\u8FDE\u63A5"}),(0,r.jsx)(O.ZP,{type:"primary",onClick:function(){je(0),Be()},children:"\u91CD\u65B0\u8FDE\u63A5"})]}),(0,r.jsxs)(y.Z,{spinning:tt,tip:"WebSocket\u8FDE\u63A5\u4E2D...",size:"large",children:[ht,(0,r.jsxs)("div",{ref:at,style:{width:"100%",height:"calc(100dvh - 80px)",display:"flex",flexDirection:"column"},children:[(0,r.jsx)("div",{style:We.chatContainer,ref:se,children:(0,r.jsx)($.Z.List,{ref:te,items:ne.map(function(d,s){return{key:s,placement:d.role,shape:"corner",content:(0,r.jsx)(Ge,{role:d.role,replyContent:d.replyContent,message:d.message,message_id:d.message_id},s)}})})}),(0,r.jsx)(fe.Z,{ref:Ze,loading:p,style:We.bottomTools,placeholder:"\u8BF7\u8F93\u5165...",autoSize:{maxRows:8},onSubmit:function(s){var e,t;we(s,"text"),(e=Ze.current)===null||e===void 0||(t=e.clear)===null||t===void 0||t.call(e)},footer:function(s){return(0,r.jsxs)(A.Z,{justify:"space-between",align:"center",children:[(0,r.jsxs)(A.Z,{gap:"small",align:"center",children:[(0,r.jsx)(Q.Z,{accept:"image/*",pastable:!0,name:"file",action:"".concat(P.H9,"/api/chat/uploadFile"),onChange:function(t){x(!0);var n=t.file.name;if(t.file.status=="uploading"){var c,l;le(Math.floor((c=(l=t.event)===null||l===void 0?void 0:l.percent)!==null&&c!==void 0?c:0),!1,!1,n)}if(t.file.status==="done"){var E;console.log(t.file.response);var L=t.file.response;if(L!=null&&(E=L.files[0])!==null&&E!==void 0&&E.error)le(100,!0,!1,n),x(!1);else{var oe;we(L==null||(oe=L.files[0])===null||oe===void 0?void 0:oe.path,"image"),le(100,!0,!0,n),x(!1)}}else t.file.status==="error"&&(le(100,!0,!1,n),x(!1))},maxCount:1,multiple:!1,showUploadList:!1,children:(0,r.jsx)(O.ZP,{disabled:v,type:"text",icon:(0,r.jsx)(ve.Z,{})})}),(0,r.jsx)(O.ZP,{type:"text",onClick:function(){return N(!0)},icon:(0,r.jsx)(Y.Z,{})}),(0,r.jsx)(U.Z,{title:"\u63D0\u793A",open:ee,onOk:function(){return ft()},confirmLoading:W,onCancel:function(){return N(!1)},children:(0,r.jsx)("p",{children:"\u786E\u8BA4\u6E05\u7A7A\u804A\u5929\u8BB0\u5F55\u5417\uFF1F\u804A\u5929\u6587\u4EF6\u4E0D\u4F1A\u88AB\u5220\u9664\u3002"})}),"@\u673A\u5668\u4EBA",(0,r.jsx)(X.Z,{size:"small",checked:Re,onChange:function(t){nt(t)}})]}),(0,r.jsx)(A.Z,{align:"center",children:s})]})},suffix:!1})]})]})]})},$e=Ye}}]);
